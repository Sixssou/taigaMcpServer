#!/bin/bash

# Run all test suites and report results
# Usage: ./scripts/run-all-tests.sh

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

cd "$PROJECT_ROOT"

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ         Taiga MCP Server - Complete Test Suite            โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

TOTAL_PASSED=0
TOTAL_FAILED=0

# Make sure no server is running
echo "๐งน Cleaning up any running servers..."
./scripts/stop-server.sh 2>/dev/null || true
echo ""

# Test 1: Unit Tests
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ฆ Running Unit Tests..."
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
if npm run test:unit; then
  echo "โ Unit tests passed"
  TOTAL_PASSED=$((TOTAL_PASSED + 1))
else
  echo "โ Unit tests failed"
  TOTAL_FAILED=$((TOTAL_FAILED + 1))
fi
echo ""

# Test 2: Quick Tests
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โก Running Quick Tests..."
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
if npm run test:quick; then
  echo "โ Quick tests passed"
  TOTAL_PASSED=$((TOTAL_PASSED + 1))
else
  echo "โ Quick tests failed"
  TOTAL_FAILED=$((TOTAL_FAILED + 1))
fi
echo ""

# Test 3: HTTP Server Tests
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ Running HTTP Server Tests..."
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
if npm run test:http; then
  echo "โ HTTP tests passed"
  TOTAL_PASSED=$((TOTAL_PASSED + 1))
else
  echo "โ HTTP tests failed"
  TOTAL_FAILED=$((TOTAL_FAILED + 1))
fi
echo ""

# Summary
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ                    Test Summary                            โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ"
echo "โ  โ Passed: $TOTAL_PASSED                                              โ"
echo "โ  โ Failed: $TOTAL_FAILED                                              โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

if [ $TOTAL_FAILED -gt 0 ]; then
  echo "โ๏ธ  Some tests failed. Please review the output above."
  exit 1
else
  echo "๐ All tests passed successfully!"
  exit 0
fi
